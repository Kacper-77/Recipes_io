import streamlit as st
from langfuse.openai import OpenAI
from langfuse.decorators import observe
from dotenv import load_dotenv
from db import init_db, save_conversation, save_recipe, get_recipes, delete_recipe

# Inicjalizacja bazy danych
init_db()
st.set_page_config(page_title="Recipes.io", layout="centered")
st.title("Recipes.:green[i]:orange[o] ğŸ‘¨ğŸ»â€ğŸ³")

# Wprowadzenie klucza API
api_key = st.text_input("WprowadÅº swÃ³j klucz API OpenAI:", type="password")

if not api_key:
    st.warning("ProszÄ™ wprowadziÄ‡ klucz API, aby korzystaÄ‡ z aplikacji.")
    st.stop()

load_dotenv()

openai_client = OpenAI(api_key=api_key)


@observe
def get_chatbot_reply(user_prompt, memory):
    messages = [
        {
            "role": "system",
            "content": """
                JesteÅ› ekspertem do spraw dietetyki,
                przepisÃ³w i wszystkiego co z tym zwiÄ…zane,
                do tego wyliczaj makro dla kaÅ¼dego z daÅ„ i podawaj w przybliÅ¼eniu
                kalorycznoÅ›Ä‡. Odpowiadaj na pytania uÅ¼ytkownika w sposÃ³b zrozumiaÅ‚y
            """
        },
    ]
    for message in memory:
        messages.append({"role": message["role"], "content": message["content"]})

    messages.append({"role": "user", "content": user_prompt})

    try:
        response = openai_client.chat.completions.create(
            model="gpt-4",
            messages=messages
        )
        return {
            "role": "assistant",
            "content": response.choices[0].message.content,
        }
    except Exception as e:
        return {
            "role": "assistant",
            "content": f"CoÅ› poszÅ‚o nie tak: {str(e)}"
        }


if "conversations" not in st.session_state:
    st.session_state["conversations"] = []

if "messages" not in st.session_state:
    st.session_state["messages"] = []

# Tworzenie tabÃ³w
tabs = st.tabs(["Chatbot", "Twoje przepisy"])

# Tab Chatbot
with tabs[0]:
    st.header("Chat")

    # WyÅ›wietlenie wszystkich wiadomoÅ›ci
    for message in st.session_state["messages"]:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # Wprowadzenie nowego promptu na dole
    prompt = st.chat_input("W czym mogÄ™ ci pomÃ³c?")

    if prompt:
        user_message = {"role": "user", "content": prompt}
        with st.chat_message("user"):
            st.markdown(user_message["content"])

        st.session_state["messages"].append(user_message)

        chatbot_message = get_chatbot_reply(prompt, memory=st.session_state["messages"][-10:])

        with st.chat_message("assistant"):
            st.markdown(chatbot_message["content"])

        st.session_state["messages"].append(chatbot_message)
        # Automatyczne zapisywanie konwersacji
        save_conversation(f"Konwersacja {len(st.session_state['conversations']) + 1}", st.session_state["messages"])

# Tab Przepisy
with tabs[1]:
    st.header("Dodaj przepis ğŸœ")

    recipe_name = st.text_input("Nazwa przepisu")
    recipe_content = st.text_area("TreÅ›Ä‡ przepisu")

    if st.button("Dodaj przepis"):
        if recipe_name and recipe_content:
            save_recipe(recipe_name, recipe_content)
            st.success("Przepis zostaÅ‚ dodany!")
        else:
            st.warning("ProszÄ™ wprowadziÄ‡ nazwÄ™ i treÅ›Ä‡ przepisu.")

    # WyÅ›wietlenie przepisÃ³w
    st.header(":orange[Twoje przepisy]")
    recipes = get_recipes()
    if recipes:
        for recipe in recipes:
            col1, col2 = st.columns([4, 1])
            with col1:
                st.subheader(recipe[1])  # Nazwa przepisu
                st.write(recipe[2])      # TreÅ›Ä‡ przepisu
            with col2:
                if st.button("UsuÅ„", key=f"delete_{recipe[0]}"):
                    delete_recipe(recipe[0])  # UsuÅ„ przepis z bazy danych
                    st.success("Przepis zostaÅ‚ usuniÄ™ty!")
                    st.experimental_rerun()  # OdÅ›wieÅ¼enie strony po usuniÄ™ciu
    else:
        st.write("Nie masz jeszcze Å¼adnych przepisÃ³w")
